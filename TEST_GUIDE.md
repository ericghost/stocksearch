# 🧪 本地测试完整指南

## 📋 测试前准备

### 1. 环境要求
- ✅ Node.js 18+ 已安装
- ✅ npm 或 yarn 包管理器
- ✅ 至少3个有效的 API 密钥（Gemini、DeepSeek、聚合数据）

### 2. API 密钥获取

#### 必需的 API 密钥

| API | 获取地址 | 用途 | 费用 |
|-----|---------|------|------|
| **Google Gemini** | https://aistudio.google.com/app/apikey | 宏观、行业、资金分析 | 有免费额度 |
| **DeepSeek** | https://platform.deepseek.com/api_keys | 技术、基本面、风控、GM决策 | 按量付费（便宜） |
| **聚合数据** | https://www.juhe.cn/ | 实时股票数据 | 有免费额度 |
| 通义千问（可选） | https://dashscope.console.aliyun.com/apiKey | 备用模型 | 有免费额度 |

---

## 🚀 快速开始

### 步骤 1: 克隆项目（如果还没有）

```bash
# 如果是从 GitHub 克隆
git clone https://github.com/164149043/AlphaCouncil-local.git
cd AlphaCouncil-local

# 如果已经在项目目录
cd c:\Users\16414\Desktop\Qoder\AlphaCouncil
```

### 步骤 2: 安装依赖

```bash
npm install
```

**预期输出：**
```
added 124 packages, and audited 125 packages in 15s
```

### 步骤 3: 配置环境变量

#### 方法 A: 复制示例文件
```bash
# Windows PowerShell
copy .env.example .env

# Windows CMD
copy .env.example .env

# 然后编辑 .env 文件，填入真实的 API 密钥
```

#### 方法 B: 手动创建 `.env` 文件

在项目根目录创建 `.env` 文件，内容如下：

```env
GEMINI_API_KEY=AIzaSy...你的Gemini密钥
DEEPSEEK_API_KEY=sk-...你的DeepSeek密钥
JUHE_API_KEY=...你的聚合数据密钥
QWEN_API_KEY=sk-...你的千问密钥（可选）
```

**⚠️ 重要提示：**
- `.env` 文件已在 `.gitignore` 中，不会被提交到 Git
- 请妥善保管你的 API 密钥

### 步骤 4: 启动开发服务器

```bash
npm run dev
```

**预期输出：**
```
  VITE v6.2.0  ready in 523 ms

  ➜  Local:   http://localhost:3000/
  ➜  Network: http://192.168.1.100:3000/
  ➜  press h + enter to show help
```

### 步骤 5: 打开浏览器

访问：**http://localhost:3000**

---

## 🧪 测试用例

### 测试 1: 基础功能测试

#### 测试目标
验证系统能否正常启动并显示界面

#### 操作步骤
1. 打开浏览器访问 `http://localhost:3000`
2. 检查页面是否正常显示
3. 查看是否有以下元素：
   - ✅ 顶部导航栏显示 "AlphaCouncil AI"
   - ✅ 输入框显示提示文字
   - ✅ "启动系统" 按钮可点击
   - ✅ 10个智能体卡片呈灰色等待状态

#### 预期结果
✅ 页面完整加载，无控制台错误

---

### 测试 2: 股票数据获取测试

#### 测试目标
验证能否成功获取股票实时数据

#### 测试用例

| 测试编号 | 股票代码 | 预期结果 |
|---------|---------|---------|
| T2.1 | 600519 | 成功获取贵州茅台数据 |
| T2.2 | 000001 | 成功获取平安银行数据 |
| T2.3 | 300750 | 成功获取宁德时代数据 |
| T2.4 | sh600519 | 自动识别上证前缀 |
| T2.5 | sz000001 | 自动识别深证前缀 |
| T2.6 | 999999 | 显示错误提示 |

#### 操作步骤（以 600519 为例）
1. 在输入框输入：`600519`
2. 点击"启动系统"
3. 观察状态栏：`状态: FETCHING_DATA`
4. 等待3-5秒

#### 预期结果
✅ 控制台输出：
```
[前端] 成功获取 贵州茅台 (sh600519) 的实时数据
[前端] 股票上下文: {currentPrice: 1850, dailyAmplitude: 4.2, ...}
```

✅ 数据源指示器显示：
```
数据源: 聚合数据 API (Juhe Data) (连接成功 - 实时数据已注入)
```

---

### 测试 3: AI 分析流程测试

#### 测试目标
验证完整的10智能体分析流程

#### 操作步骤
1. 输入股票代码：`600519`
2. 点击"启动系统"
3. 观察各阶段卡片状态变化

#### 预期流程

| 阶段 | 时间 | 状态指示 | 卡片变化 |
|------|------|---------|---------|
| 数据获取 | 0-5s | `FETCHING_DATA` | 所有卡片灰色 |
| 第一阶段 | 5-25s | `RUNNING - 当前步骤: 1` | 5个分析师卡片打字机动画 |
| 第二阶段 | 25-40s | `RUNNING - 当前步骤: 2` | 2个总监卡片打字机动画 |
| 第三阶段 | 40-55s | `RUNNING - 当前步骤: 3` | 2个风控卡片打字机动画 |
| 第四阶段 | 55-70s | `RUNNING - 当前步骤: 4` | 总经理卡片打字机动画 |
| 完成 | 70s+ | `COMPLETED` | 所有卡片显示完整内容 |

#### 预期结果

✅ **第一阶段卡片内容包含：**
- 宏观政策分析师：宏观评级、政策风口
- 行业轮动分析师：最强主线、柱状图
- 技术分析专家：技术形态、**买入区间、卖出区间、止损价格**
- 资金流向分析师：资金意图、盘口密码
- 基本面分析师：估值水位、雷达图

✅ **总经理输出包含：**
```markdown
### 🧭 最终指令
【🟢 买入】

### 📌 仓位
【60%】

### 📈 操作区间
- **买入区间：** 1750.50 - 1820.00
- **卖出区间：** 2050.00 - 2150.00

### 🛑 止损红线
**止损：** 1680.00

---

## 📊 区间验证报告

### 验证结果: ✅ 通过
- 总区间宽度: 15.2%
- 买入区间宽度: 4.5%
- 卖出区间宽度: 6.8%
...
```

---

### 测试 4: 区间验证功能测试

#### 测试目标
验证 `intervalUtils.ts` 的区间验证和调整功能

#### 测试 4.1: 标准区间（无需调整）

**输入：** 技术分析师给出合理区间
```
- 买入区间：85.50 - 90.20
- 卖出区间：110.30 - 118.50
- 止损：82.00
```

**当前价：** 100.00

**预期结果：**
```
✅ 验证通过
- 买入区间宽度: 4.7% (≥4% ✓)
- 卖出区间宽度: 8.2% (≥5% ✓)
- 买入区间低于当前价: 9.8% (≥6% ✓)
- 卖出区间高于当前价: 10.3% (≥10% ✓)
```

#### 测试 4.2: 过窄区间（自动调整）

**输入：** 技术分析师给出过窄区间
```
- 买入区间：95.00 - 97.00
- 卖出区间：102.00 - 105.00
```

**当前价：** 100.00

**预期结果：**
```
⚠️ 需要调整
自动调整项：
- 买入区间宽度从2.0%扩大到4.0%
- 买入区间下调5.00元以远离当前价
- 卖出区间宽度从3.0%扩大到5.0%
- 卖出区间上移8.00元以远离当前价

调整后区间：
- 买入区间: 85.00 - 89.00
- 卖出区间: 110.00 - 115.00
```

---

### 测试 5: 错误处理测试

#### 测试 5.1: API 密钥错误

**操作：** 在 `.env` 中使用错误的 API 密钥

**预期结果：**
```
错误提示: "未配置 Gemini API Key。请在前端输入 API Key 或联系管理员设置环境变量"
```

#### 测试 5.2: 股票代码错误

**测试用例：**
| 输入 | 预期错误提示 |
|------|-------------|
| `abc123` | "股票代码格式错误，应为6位数字" |
| `123` | "股票代码应为6位数字" |
| `700000` | "不是有效的沪深股市代码" |

#### 测试 5.3: 网络错误

**操作：** 断开网络连接后提交分析

**预期结果：**
```
错误提示: "无法获取股票数据，请检查网络连接"
```

---

## 🔍 控制台日志检查

### 正常流程的控制台输出示例

```javascript
// 1. 数据获取阶段
[前端] 成功获取 贵州茅台 (sh600519) 的实时数据
[前端] 股票上下文: {
  currentPrice: 1850,
  dailyAmplitude: 4.2,
  volume: 12500000,
  turnover: 2312500000,
  priceChange: 2.5,
  volatility20d: 0.076,
  marketIndex: { name: "上证指数", point: 3200.5, change: -0.8 }
}

// 2. AI 分析阶段
[Gemini] 宏观政策分析师 已启用 Google Search Grounding
[Gemini] 行业轮动分析师 已启用 Google Search Grounding
[Gemini] 资金流向分析师 已启用 Google Search Grounding

// 3. 区间验证阶段
[区间提取] ✅ 成功提取: {
  buyRange: [1750.5, 1820],
  sellRange: [2050, 2150],
  stopLoss: 1680
}

// 4. 完成
分析完成！耗时: 68.5s
```

### 错误日志示例

```javascript
// API 调用失败
[Gemini] 请求失败: Invalid API key

// 区间提取失败（不影响流程）
[区间验证] 自动验证失败，保留原始输出: Cannot extract intervals from text

// 股票数据获取失败
[AlphaCouncil] 获取股票数据失败: Network error
```

---

## 📊 性能基准测试

### 预期性能指标

| 指标 | 预期值 | 说明 |
|------|--------|------|
| 页面首次加载 | < 2s | 白屏时间 |
| 数据获取 | 2-5s | 聚合数据 API 响应 |
| 第一阶段分析 | 15-25s | 5个智能体并行 |
| 第二阶段分析 | 10-15s | 2个总监并行 |
| 第三阶段分析 | 10-15s | 2个风控并行 |
| 第四阶段分析 | 10-20s | 总经理决策 |
| 总耗时 | 60-80s | 完整流程 |

### 性能优化建议

如果耗时过长：
- ✅ 检查网络连接速度
- ✅ 确认 API 密钥有效且未超额
- ✅ 查看控制台是否有重复请求
- ✅ 清除浏览器缓存重试

---

## 🐛 常见问题排查

### 问题 1: 页面白屏

**可能原因：**
- Node.js 版本过低
- 依赖安装不完整

**解决方案：**
```bash
# 检查 Node.js 版本
node -v  # 应该 >= 18.0.0

# 清除依赖重新安装
rm -rf node_modules package-lock.json
npm install
```

### 问题 2: API 调用失败

**可能原因：**
- API 密钥错误或过期
- 额度耗尽

**解决方案：**
1. 检查 `.env` 文件是否正确
2. 在 API 平台检查剩余额度
3. 尝试在前端手动输入 API 密钥

### 问题 3: 区间验证不生效

**可能原因：**
- AI 输出格式不符合规范

**解决方案：**
```bash
# 运行测试脚本验证
npx tsx test-interval-utils.ts
```

查看控制台输出，确认提取逻辑是否正常。

### 问题 4: 打字机动画卡顿

**可能原因：**
- 浏览器性能不足
- 音效冲突

**解决方案：**
- 使用 Chrome/Edge 最新版本
- 关闭其他占用资源的标签页

---

## ✅ 测试清单

完成以下所有测试项即可确认系统正常：

### 基础功能
- [ ] 页面正常加载，无白屏
- [ ] 输入框可以输入股票代码
- [ ] "启动系统" 按钮可点击
- [ ] 10个智能体卡片正常显示

### 数据获取
- [ ] 输入有效代码能获取实时数据
- [ ] 数据源指示器显示"连接成功"
- [ ] 控制台输出股票上下文
- [ ] 无效代码显示错误提示

### AI 分析
- [ ] 第一阶段：5个分析师并行输出
- [ ] 第二阶段：2个总监整合报告
- [ ] 第三阶段：2个风控评估
- [ ] 第四阶段：总经理给出明确指令

### 区间验证
- [ ] 技术分析师输出包含买入/卖出区间
- [ ] 总经理输出符合标准化格式
- [ ] 区间验证报告自动生成
- [ ] 过窄区间被自动调整

### 错误处理
- [ ] API 密钥错误时提示友好
- [ ] 网络错误时不崩溃
- [ ] 无效股票代码被拒绝
- [ ] 区间提取失败不影响流程

---

## 🚀 高级测试

### 单元测试运行

```bash
# 运行区间验证测试
npx tsx test-interval-utils.ts
```

**预期输出：**
```
========================================
📊 区间验证工具测试
========================================

【测试 1】标准格式提取
提取结果: { buyRange: [85.5, 90.2], sellRange: [110.3, 118.5], stopLoss: 82 }
验证结果: { meetsStandards: true, totalWidthPercent: 15.2, ... }

========================================
✅ 测试完成
========================================
```

### 压力测试

连续分析10只不同股票，检查：
- [ ] 系统稳定性
- [ ] 内存占用是否正常
- [ ] API 额度消耗情况

---

## 📝 测试报告模板

完成测试后，请填写以下报告：

```markdown
## 测试环境
- 操作系统: Windows 11 24H2
- Node.js 版本: v18.17.0
- 浏览器: Chrome 120.0
- 测试时间: 2025-12-01 14:30

## 测试结果
- ✅ 基础功能: 通过
- ✅ 数据获取: 通过
- ✅ AI 分析: 通过
- ✅ 区间验证: 通过
- ✅ 错误处理: 通过

## 性能数据
- 首次加载: 1.8s
- 完整分析: 72.3s
- 内存占用: 256MB

## 发现的问题
1. 无

## 建议
1. 区间验证功能工作正常
2. 建议后续添加历史记录功能
```

---

**🎉 测试完成！** 如有任何问题，请查看 `INTEGRATION_GUIDE.md` 或联系开发团队。
